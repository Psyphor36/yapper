<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yapper // Local AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        yap: {
                            400: '#fbbf24', // Amber 400
                            500: '#f59e0b', // Amber 500
                            600: '#d97706', // Amber 600
                            900: '#451a03',
                        },
                        neutral: {
                            800: '#262626',
                            900: '#171717',
                            950: '#0a0a0a',
                        }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0a0a0a;
            color: #e5e5e5;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #171717; }
        ::-webkit-scrollbar-thumb { background: #404040; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #f59e0b; }

        .chat-bubble { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .prose code {
            color: #fbbf24 !important;
            background: #262626 !important;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
        }

        .loader-stripes {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: moveStripes 1s linear infinite;
        }
        
        @keyframes moveStripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-neutral-950 text-neutral-100 selection:bg-yap-500 selection:text-black">

    <!-- Header -->
    <header class="border-b border-white/10 bg-neutral-900/80 backdrop-blur-md p-4 flex justify-between items-center z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-yap-500 flex items-center justify-center text-black font-extrabold transform -rotate-3 shadow-[0_0_15px_rgba(245,158,11,0.3)]">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">Yapper<span class="text-yap-500">.io</span></h1>
                <div class="flex items-center gap-2 text-[10px] text-neutral-500 mono uppercase tracking-wider">
                    <span id="status-badge" class="text-yap-500 animate-pulse">Connecting...</span>
                    <span class="text-neutral-700">|</span>
                    <span class="text-neutral-400">Nano Model</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
             <div class="text-xs text-neutral-500 hidden md:block opacity-60">
                v2.0 • 135M params
             </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-1 overflow-y-auto p-4 md:p-6 relative">
        
        <!-- Loading Overlay -->
        <div id="loading-state" class="absolute inset-0 flex flex-col items-center justify-center bg-neutral-950 z-10 transition-opacity duration-500">
            <div class="w-full max-w-xs text-center space-y-6">
                
                <!-- Logo Animation -->
                <div class="relative inline-block mb-2">
                    <div class="absolute inset-0 bg-yap-500 blur-2xl opacity-10 animate-pulse-slow"></div>
                    <i class="fas fa-comments text-6xl text-neutral-800 animate-bounce-slow relative z-10"></i>
                    <i class="fas fa-bolt text-3xl text-yap-500 absolute -top-2 -right-4 animate-bounce relative z-10"></i>
                </div>
                
                <div>
                    <h2 class="text-xl font-bold text-white mb-2">Waking up Yapper...</h2>
                    <p id="loading-text" class="text-sm text-neutral-500 font-mono">Initializing Neural Engine</p>
                </div>

                <!-- Progress Bar -->
                <div class="relative w-full h-1 bg-neutral-900 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-yap-500 w-0 transition-all duration-200 shadow-[0_0_10px_rgba(245,158,11,0.5)]"></div>
                </div>
                <div id="progress-percent" class="text-xs font-bold text-yap-500 font-mono">0%</div>
                
                <p class="text-[10px] text-neutral-700 max-w-[200px] mx-auto leading-relaxed">
                    Downloading lightweight model (~90MB).<br>Runs 100% offline once loaded.
                </p>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-interface" class="max-w-3xl mx-auto h-full flex flex-col opacity-0 transition-opacity duration-1000">
            <div id="messages" class="flex-1 flex flex-col gap-6 pb-4">
                <!-- Messages injected here -->
            </div>
        </div>

    </main>

    <!-- Footer / Input -->
    <footer class="p-4 bg-neutral-900 border-t border-white/5 z-20">
        <div class="max-w-3xl mx-auto">
            <form id="chat-form" class="relative">
                <textarea 
                    id="user-input" 
                    rows="1"
                    placeholder="Initializing..." 
                    class="w-full bg-neutral-950 text-white border border-neutral-800 rounded-xl pl-4 pr-12 py-4 focus:outline-none focus:border-yap-500/50 focus:ring-1 focus:ring-yap-500/50 transition-all resize-none shadow-lg placeholder-neutral-600 disabled:opacity-50 disabled:cursor-wait font-light"
                    disabled
                ></textarea>
                
                <button 
                    type="submit" 
                    id="send-btn"
                    class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-lg bg-yap-500 text-black font-bold hover:bg-yap-400 disabled:bg-neutral-800 disabled:text-neutral-600 transition-all disabled:cursor-not-allowed transform active:scale-95"
                    disabled
                >
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </form>
            
            <div class="flex justify-between items-center mt-2 px-1">
                <div class="text-[10px] text-neutral-600 mono">
                    <span id="tps-counter">Ready</span>
                </div>
                <div class="text-[10px] text-neutral-600">
                    <span class="text-yap-600">●</span> Private & Local
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@1.1.1/esm/index.js';

        // Config
        const WLLAMA_PATHS = {
            'single-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@1.1.1/esm/single-thread/wllama.wasm',
            'multi-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama@1.1.1/esm/multi-thread/wllama.wasm',
        };

        // SmolLM2-135M - Extremely small (~90MB), fast, and unlikely to be blocked.
        const MODEL_URL = "https://huggingface.co/HuggingFaceTB/SmolLM2-135M-Instruct-GGUF/resolve/main/smollm2-135m-instruct-q4_k_m.gguf";

        const SYSTEM_PROMPT = `You are Yapper, a fun AI.
        Personality: Enthusiastic, chatty, informal, helpful.
        Use casual language. Keep it brief.`;

        // State
        let wllama = null;
        let isGenerating = false;
        let history = [{ role: "system", content: SYSTEM_PROMPT }];

        // DOM
        const els = {
            loading: document.getElementById('loading-state'),
            progressBar: document.getElementById('progress-bar'),
            progressPercent: document.getElementById('progress-percent'),
            loadingText: document.getElementById('loading-text'),
            chatInterface: document.getElementById('chat-interface'),
            messages: document.getElementById('messages'),
            input: document.getElementById('user-input'),
            btn: document.getElementById('send-btn'),
            form: document.getElementById('chat-form'),
            statusBadge: document.getElementById('status-badge'),
            tps: document.getElementById('tps-counter'),
        };

        // --- Core Functions ---

        async function init() {
            try {
                wllama = new Wllama(WLLAMA_PATHS);
                
                els.loadingText.innerText = "Downloading Logic (135M)...";
                
                await wllama.loadModelFromUrl(MODEL_URL, {
                    n_ctx: 1024, // Smaller context for speed/memory safety
                    progressCallback: (report) => {
                        const pct = Math.round(report.loaded / report.total * 100) || 0;
                        els.progressBar.style.width = `${pct}%`;
                        els.progressPercent.innerText = `${pct}%`;
                    }
                });

                onLoadSuccess();

            } catch (err) {
                console.error(err);
                els.loadingText.innerHTML = `<span class="text-red-500">Connection Failed. Refresh to retry.</span>`;
                els.progressBar.classList.add('bg-red-500');
            }
        }

        function onLoadSuccess() {
            // UI Transition
            els.loading.classList.add('opacity-0', 'pointer-events-none');
            els.chatInterface.classList.remove('opacity-0');
            
            // Status Updates
            els.statusBadge.innerText = "ONLINE";
            els.statusBadge.classList.remove('animate-pulse', 'text-yap-500');
            els.statusBadge.classList.add('text-green-500');
            
            // Enable Chat
            els.input.disabled = false;
            els.input.placeholder = "Yap at me...";
            els.btn.disabled = false;
            els.input.focus();
            
            // Initial Message
            setTimeout(() => {
                addMessage('assistant', "Yo! Yapper here. I'm tiny but I'm fast. What's good?");
            }, 500);
        }

        // --- Chat Logic ---

        els.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = els.input.value.trim();
            if (!text || isGenerating) return;

            // UI Updates
            els.input.value = '';
            els.input.style.height = 'auto';
            els.input.disabled = true;
            els.btn.disabled = true;
            isGenerating = true;

            // Add User Message
            addMessage('user', text);
            history.push({ role: 'user', content: text });

            // Create AI Message container
            const aiMsg = addMessage('assistant', '');
            const contentEl = aiMsg.querySelector('.content');
            
            let fullText = "";
            let startTime = performance.now();
            let tokens = 0;

            try {
                // SmolLM2 Template (ChatML)
                const prompt = history.map(m => 
                    `<|im_start|>${m.role}\n${m.content}<|im_end|>`
                ).join('\n') + "\n<|im_start|>assistant\n";

                await wllama.createCompletion(prompt, {
                    nPredict: 256, // Keep it snappy
                    sampling: { temp: 0.6, top_p: 0.9 },
                    onNewToken: (token, piece) => {
                        fullText += piece;
                        contentEl.innerHTML = marked.parse(fullText);
                        
                        // Auto-scroll
                        const main = document.getElementById('main-container');
                        main.scrollTop = main.scrollHeight;

                        // Stats
                        tokens++;
                        const sec = (performance.now() - startTime) / 1000;
                        if (sec > 1) els.tps.innerText = `${(tokens/sec).toFixed(1)} t/s`;
                    }
                });

                history.push({ role: 'assistant', content: fullText });

            } catch (err) {
                contentEl.innerHTML += `<br><span class="text-red-500 text-xs">[Error: ${err.message}]</span>`;
            } finally {
                isGenerating = false;
                els.input.disabled = false;
                els.btn.disabled = false;
                els.input.focus();
            }
        });

        // Utilities
        els.input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        function addMessage(role, text) {
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `chat-bubble flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const avatar = isUser ? '' : `
                <div class="w-8 h-8 rounded-lg bg-neutral-800 flex items-center justify-center mr-3 border border-neutral-700 shadow-sm">
                    <i class="fas fa-bolt text-yap-500 text-xs"></i>
                </div>`;

            const bubbleStyle = isUser 
                ? 'bg-neutral-800 text-white rounded-2xl rounded-tr-sm px-4 py-2 border border-neutral-700 max-w-[85%] shadow-md' 
                : 'text-neutral-300 max-w-[90%] prose prose-invert prose-p:leading-relaxed prose-sm';

            div.innerHTML = `
                ${avatar}
                <div class="${bubbleStyle} content">
                    ${isUser ? text : '<span class="animate-pulse text-yap-500">...</span>'}
                </div>
            `;
            
            els.messages.appendChild(div);
            const main = document.getElementById('main-container');
            main.scrollTop = main.scrollHeight;
            return div;
        }

        // Start
        init();

    </script>
</body>
</html>
